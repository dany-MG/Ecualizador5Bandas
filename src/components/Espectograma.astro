---
interface Props {
  id: string;
}
const { id } = Astro.props;
---

<div
  id={`compare-container-${id}`}
  class="w-full h-full relative rounded-lg overflow-hidden bg-slate-900/40 border border-white/5 group select-none"
>
  <div class="absolute inset-0 z-0 w-full h-full">
    <div id={`spectrogram-ws-${id}`} class="w-full h-full"></div>
    <span
      class="absolute top-2 left-2 text-xs bg-black/60 text-slate-300 px-2 py-0.5 rounded border border-white/10 pointer-events-none z-10 backdrop-blur-sm"
    >
      Original (Input)
    </span>
  </div>

  <div
    id={`layer-processed-${id}`}
    class="absolute inset-0 z-20 bg-slate-900 w-full h-full opacity-0 transition-opacity duration-500"
    style="clip-path: inset(0 100% 0 0);"
  >
    <img
      id={`spectrogram-py-${id}`}
      class="w-full h-full object-cover"
      alt="Espectrograma Procesado"
    />
    <span
      class="absolute top-2 right-2 text-xs bg-cyan-900/80 text-cyan-300 px-2 py-0.5 rounded border border-cyan-500/30 pointer-events-none backdrop-blur-sm"
    >
      Procesado (Python)
    </span>
  </div>

  <div
    id={`spectrogram-placeholder-${id}`}
    class="absolute inset-0 flex items-center justify-center text-white/10 text-xs tracking-widest pointer-events-none z-0"
  >
    WAITING FOR SIGNAL...
  </div>

  <div
    id={`slider-handle-${id}`}
    class="hidden absolute top-0 bottom-0 w-0.5 bg-cyan-400 z-30 shadow-[0_0_10px_rgba(34,211,238,0.8)] pointer-events-none"
    style="left: 0%;"
  >
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-6 bg-slate-900 border border-cyan-500 rounded-full shadow-lg flex items-center justify-center text-cyan-400"
    >
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg
      >
    </div>
  </div>
</div>

<style is:global>
  /* Mismos estilos globales para WaveSurfer que ya tenías */
  [id^="spectrogram-ws-"] > div {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
  }

  [id^="spectrogram-ws-"] canvas:not([part="spec-labels"]) {
    width: 100% !important;
    height: 100% !important;
    left: 0 !important;
    top: 0 !important;
    image-rendering: auto; /* Suavizar para que no se vea pixelado al estirar */
  }

  [id^="spectrogram-ws-"] canvas[part="spec-labels"] {
    width: auto !important; /* Dejar que ocupe solo lo necesario */
    font-family: "Saira", sans-serif !important;
    max-width: 55px !important; /* Limitar ancho máximo por seguridad */
    height: 100% !important;
    z-index: 10 !important;
    background: transparent !important;
    left: 0 !important;
  }
</style>

<script define:vars={{ id }}>
  const container = document.getElementById(`compare-container-${id}`);
  const layerProcessed = document.getElementById(`layer-processed-${id}`);
  const imgProcessed = document.getElementById(`spectrogram-py-${id}`);
  const handle = document.getElementById(`slider-handle-${id}`);

  let isComparisonActive = false;

  // 1. CONTROL DEL MOUSE (Slider Effect)
  container.addEventListener("mousemove", (e) => {
    if (!isComparisonActive) return;

    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    let percentage = (x / rect.width) * 100;
    percentage = Math.max(0, Math.min(100, percentage));

    // Mover la línea
    handle.style.left = `${percentage}%`;

    // Recortar la capa superior (Procesada)
    // inset(top right bottom left) -> Recortamos desde la IZQUIERDA para revelar la derecha
    // Queremos ver la capa procesada a la IZQUIERDA del mouse
    layerProcessed.style.clipPath = `inset(0 ${100 - percentage}% 0 0)`;
  });

  container.addEventListener(
    "touchmove",
    (e) => {
      if (!isComparisonActive) return;

      // Evita que la página haga scroll mientras mueves el slider
      e.preventDefault();

      const rect = container.getBoundingClientRect();
      const touch = e.touches[0]; // El primer dedo que toca la pantalla
      const x = touch.clientX - rect.left;

      let percentage = (x / rect.width) * 100;
      percentage = Math.max(0, Math.min(100, percentage));

      handle.style.left = `${percentage}%`;
      layerProcessed.style.clipPath = `inset(0 ${100 - percentage}% 0 0)`;
    },
    { passive: false }
  );

  // 2. ESCUCHAR CUANDO LLEGA LA IMAGEN DE PYTHON
  document.addEventListener("spectrogram-generated", (e) => {
    const { targetId, imageUrl } = e.detail;

    if (targetId === id) {
      // Asignar imagen
      imgProcessed.src = imageUrl;

      // Activar modo comparación
      isComparisonActive = true;

      // Mostrar capa y handle
      layerProcessed.classList.remove("opacity-0");
      handle.classList.remove("hidden");

      // Resetear slider al 50%
      handle.style.left = "50%";
      layerProcessed.style.clipPath = `inset(0 50% 0 0)`;
    }
  });

  // 3. RESETEAR SI SE CARGA UN NUEVO ARCHIVO
  document.addEventListener("file-loaded", (e) => {
    if (e.detail.id === id) {
      isComparisonActive = false;
      layerProcessed.classList.add("opacity-0");
      handle.classList.add("hidden");
      imgProcessed.src = "";
    }
  });
</script>
